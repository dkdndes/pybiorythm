name: Manual Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - staging  
          - prod
      image_tag:
        description: 'Docker image tag to deploy'
        required: true
        type: string
        default: 'latest'
      deployment_type:
        description: 'Deployment strategy'
        required: true
        type: choice
        options:
          - rolling
          - blue-green
        default: 'rolling'
      deployment_slot:
        description: 'Blue-green deployment slot (only for blue-green)'
        required: false
        type: choice
        options:
          - blue
          - green
        default: 'blue'
      switch_traffic:
        description: 'Switch traffic after deployment (blue-green only)'
        required: false
        type: boolean
        default: false

jobs:
  deploy:
    name: Deploy to ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
    - name: Show deployment info
      run: |
        echo "🚀 Manual Deployment Started"
        echo "=========================="
        echo "Environment: ${{ github.event.inputs.environment }}"
        echo "Image Tag: ${{ github.event.inputs.image_tag }}"
        echo "Strategy: ${{ github.event.inputs.deployment_type }}"
        echo ""
        
        if [ "${{ github.event.inputs.deployment_type }}" = "blue-green" ]; then
          SLOT="${{ github.event.inputs.deployment_slot }}"
          OTHER_SLOT=$([ "$SLOT" = "blue" ] && echo "green" || echo "blue")
          
          echo "🔄 Blue-Green Deployment Process:"
          echo "1. ✅ Validate deployment inputs"
          echo "2. 🔍 Check if image exists: ghcr.io/dkdndes/pybiorythm:${{ github.event.inputs.image_tag }}"
          echo "3. 🚢 Deploy to $SLOT slot (inactive)"
          echo "4. 🏥 Run health checks on $SLOT slot"
          echo "Target slot: $SLOT"
          echo "Current active slot: $OTHER_SLOT"
          
          if [ "${{ github.event.inputs.switch_traffic }}" = "true" ]; then
            echo "5. 🔀 Switch traffic from $OTHER_SLOT to $SLOT"
            echo "6. 🧹 Scale down $OTHER_SLOT slot"
            echo "✅ Traffic will be switched automatically"
          else
            echo "5. ⏸️  Traffic switch skipped (manual intervention required)"
            echo "   Use: kubectl patch service app-${{ github.event.inputs.environment }} -p '{\"spec\":{\"selector\":{\"slot\":\"$SLOT\"}}}'"
          fi
        else
          echo "📈 Rolling Deployment Process:"
          echo "1. ✅ Validate deployment inputs" 
          echo "2. 🔍 Check if image exists: ghcr.io/dkdndes/pybiorythm:${{ github.event.inputs.image_tag }}"
          echo "3. 🚢 Rolling update deployment"
          echo "4. 🏥 Wait for pods to be ready"
        fi
        
        echo ""
        echo "✅ Deployment simulation completed!"
        echo "📋 Ready for actual deployment to ${{ github.event.inputs.environment }} environment"